<!DOCTYPE HTML>
<html>
  <head>
    <title>UC Merced Resources</title>
    <meta charset="utf-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1, user-scalable=no" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <noscript><link rel="stylesheet" href="/assets/css/noscript.css" /></noscript>
  </head>
  <body class="is-preload">
    <div id="wrapper">

      <!-- Header -->
      <header id="header">
        <div class="inner">
          <a href="/" class="logo">
            <span class="symbol"><img src="/images/logo.svg" alt="" /></span>
            <span class="title">UC Merced Resources</span>
          </a>

          <nav>
            <ul>
              <li><a href="/">Student View</a></li>
              <li><a href="/admin">Admin Dashboard</a></li>
              <li><a href="#menu">Menu</a></li>
            </ul>
          </nav>
        </div>
      </header>

      <!-- Menu -->
      <nav id="menu">
        <h2>Menu</h2>
        <ul>
          <li><a href="/">Student View</a></li>
          <li><a href="/admin">Admin Dashboard</a></li>
        </ul>
      </nav>

      <!-- Main -->
      <div id="main">
        <div class="inner">

          <header>
            <h1>Free On-Campus Resources</h1>
            <p>
              Browse UC Merced resources, add them to your cart, and check them out
              under your student account. You can also view and manage your
              resource history.
            </p>
          </header>

          <!-- Resource Catalog + Cart -->
          <section id="resource-browser">
            <h2>Browse Resources</h2>

            <div class="row">
              <div class="col-8 col-12-medium">
                <div class="fields">
                  <div class="field half">
                    <label for="filter-category">Filter by category</label>
                    <select id="filter-category">
                      <option value="">All categories</option>
                      <option value="supplies">Student Supplies</option>
                      <option value="tutoring">Tutoring</option>
                      <option value="health">Health Services</option>
                      <option value="funding">Funding</option>
                      <option value="academic_support">Academic Support</option>
                      <option value="advisor">Advisors</option>
                    </select>
                  </div>
                  <div class="field half">
                    <label for="filter-search">Search (like Ctrl+F)</label>
                    <input type="text"
                          id="filter-search"
                          placeholder="Type to search name, department, location, etc." />
                  </div>
                </div>


                <div id="resource-table-wrapper">
                  <p>Loading resources...</p>
                </div>
              </div>

              <div class="col-4 col-12-medium">
                <h3>Your Cart</h3>
                <div id="cart-contents">
                  <p>No items in cart.</p>
                </div>

                <hr />

                <h3>Checkout</h3>
                <form id="checkout-form">
                  <div class="fields">
                    <div class="field">
                      <label for="checkout-name">Student Name</label>
                      <input type="text" id="checkout-name" placeholder="e.g. Rufus T. Bobcat" required />
                    </div>
                    <div class="field">
                      <label for="checkout-id">Student ID</label>
                      <input type="text" id="checkout-id" placeholder="e.g. U200123" required />
                    </div>
                    <div class="field">
                      <label for="checkout-password">Password</label>
                      <input type="password" id="checkout-password" placeholder="Create or use existing" required />
                    </div>
                  </div>
                  <ul class="actions">
                    <li><input type="submit" value="Checkout Cart" class="primary" /></li>
                  </ul>
                  <p id="checkout-status"></p>
                </form>
              </div>
            </div>
          </section>

          <hr />

          <!-- Most Popular Resources -->
          <section id="popular-resources">
            <h2>Most Popular Resources</h2>
            <p>
              These are the campus resources that students are using the most,
              across all categories (supplies, tutoring, health, funding,
              academic support, and advising).
            </p>

            <div id="popular-resources-wrapper">
              <p>Loading popular resources...</p>
            </div>
          </section>


          <!-- Resource History -->
          <section id="student-history">
            <h2>Student Resource History</h2>
            <p>
              Log in with your Student ID and password to see everything you've
              checked out. You can remove individual entries if needed.
            </p>

            <form id="history-form">
              <div class="fields">
                <div class="field">
                  <label for="history-id">Student ID</label>
                  <input type="text" id="history-id" placeholder="U200123" required />
                </div>
                <div class="field">
                  <label for="history-password">Password</label>
                  <input type="password" id="history-password" placeholder="Your student password" required />
                </div>
              </div>
              <ul class="actions">
                <li><input type="submit" value="View History" class="primary" /></li>
              </ul>
            </form>

            <div id="history-results">
              <!-- history table goes here -->
            </div>
          </section>

        </div>
      </div>

      <!-- Footer -->
      <footer id="footer">
        <div class="inner">
          <ul class="copyright">
            <li>&copy; UC Merced Resources (demo). All rights reserved.</li>
          </ul>
        </div>
      </footer>

    </div>

    <!-- Scripts (same template stack) -->
    <script src="/assets/js/jquery.min.js"></script>
    <script src="/assets/js/browser.min.js"></script>
    <script src="/assets/js/breakpoints.min.js"></script>
    <script src="/assets/js/util.js"></script>
    <script src="/assets/js/main.js"></script>

    <!-- Page-specific JS -->
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const filterCategory   = document.getElementById("filter-category");
        const filterSearch     = document.getElementById("filter-search");
        const resourceWrapper  = document.getElementById("resource-table-wrapper");
        const cartContents     = document.getElementById("cart-contents");
        const checkoutForm     = document.getElementById("checkout-form");
        const checkoutStatus   = document.getElementById("checkout-status");

        const historyForm      = document.getElementById("history-form");
        const historyResults   = document.getElementById("history-results");

        const form             = document.getElementById("resource-form");
        const resultsContainer = document.getElementById("resource-results");
        const popularContainer = document.getElementById("popular-resources-wrapper");

        // Cart data: array of {category_key, resource_id, name, category}
        let cart = [];
        let allResources = [];

        // History data (after login)
        let historyData = [];
        let historyStudentID = "";
        let historyPassword = "";

        // ------------------------
        // Helpers
        // ------------------------
        function escapeHtml(value) {
          return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function renderResourceTable(resources) {
          if (!resources || !resources.length) {
            resourceWrapper.innerHTML = "<p>No resources found.</p>";
            return;
          }

          let html = `
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Add</th>
                    <th>Category</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Building</th>
                    <th>Location</th>
                    <th>When</th>
                    <th>Notes / Link</th>
                  </tr>
                </thead>
                <tbody>
          `;

          resources.forEach((r, index) => {
            const when = r.weekday
              ? (r.weekday + " " + (r.start_time || "") + "-" + (r.end_time || "")).trim()
              : "";
            const notes = r.notes || "";
            const link  = r.link ? `<a href="${escapeHtml(r.link)}" target="_blank">Link</a>` : "";

            html += `
              <tr>
                <td>
                  <button type="button"
                          class="button small"
                          data-add-index="${index}">
                    Add
                  </button>
                </td>
                <td>${escapeHtml(r.category)}</td>
                <td>${escapeHtml(r.name)}</td>
                <td>${escapeHtml(r.department)}</td>
                <td>${escapeHtml(r.building)}</td>
                <td>${escapeHtml(r.location)}</td>
                <td>${escapeHtml(when)}</td>
                <td>${escapeHtml(notes)} ${link}</td>
              </tr>
            `;
          });

          html += `
                </tbody>
              </table>
            </div>
          `;

          resourceWrapper.innerHTML = html;

          // attach add-to-cart buttons
          resourceWrapper.querySelectorAll("button[data-add-index]").forEach(btn => {
            btn.addEventListener("click", function () {
              const idx = parseInt(btn.getAttribute("data-add-index"), 10);
              const item = resources[idx];
              if (!item) return;
              cart.push({
                category_key: item.category_key,
                resource_id: item.resource_id,
                name: item.name,
                category: item.category
              });
              renderCart();
            });
          });
        }

        function renderCart() {
          if (!cart.length) {
            cartContents.innerHTML = "<p>No items in cart.</p>";
            return;
          }

          let html = `<ul>`;
          cart.forEach((item, index) => {
            html += `
              <li>
                [${escapeHtml(item.category)}] ${escapeHtml(item.name)}
                <button type="button"
                        class="button small"
                        data-remove-index="${index}">
                  Remove
                </button>
              </li>
            `;
          });
          html += `</ul>`;

          cartContents.innerHTML = html;

          cartContents.querySelectorAll("button[data-remove-index]").forEach(btn => {
            btn.addEventListener("click", function () {
              const idx = parseInt(btn.getAttribute("data-remove-index"), 10);
              if (!isNaN(idx)) {
                cart.splice(idx, 1);
                renderCart();
              }
            });
          });
        }

        function renderHistoryTable(data) {
          if (!data || !data.length) {
            historyResults.innerHTML = "<p>No resources found for this student.</p>";
            return;
          }

          let html = `
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Category</th>
                    <th>Name</th>
                    <th>Department</th>
                    <th>Building</th>
                    <th>Location</th>
                    <th>When</th>
                    <th>Link</th>
                    <th>Delete</th>
                  </tr>
                </thead>
                <tbody>
          `;

          data.forEach((item, index) => {
            const when = item.weekday
              ? (item.weekday + " " + (item.start_time || "") + "-" + (item.end_time || "")).trim()
              : "";
            const link = item.link ? `<a href="${escapeHtml(item.link)}" target="_blank">Link</a>` : "";

            html += `
              <tr>
                <td>${escapeHtml(item.category)}</td>
                <td>${escapeHtml(item.name)}</td>
                <td>${escapeHtml(item.department)}</td>
                <td>${escapeHtml(item.building)}</td>
                <td>${escapeHtml(item.location)}</td>
                <td>${escapeHtml(when)}</td>
                <td>${link}</td>
                <td>
                  <button type="button"
                          class="button small"
                          data-delete-index="${index}">
                    Delete
                  </button>
                </td>
              </tr>
            `;
          });

          html += `
                </tbody>
              </table>
            </div>
          `;

          historyResults.innerHTML = html;
        }

        // ------------------------
        // Popular resources
        // ------------------------
        async function loadPopularResources() {
          if (!popularContainer) return;

          popularContainer.innerHTML = "<p>Loading popular resources...</p>";

          try {
            const res = await fetch("/api/popular-resources?limit=10");
            const data = await res.json();

            if (!res.ok) {
              popularContainer.innerHTML =
                `<p>Error loading popular resources: ${data.error || "Request failed."}</p>`;
              return;
            }

            if (!Array.isArray(data) || !data.length) {
              popularContainer.innerHTML = "<p>No usage data yet.</p>";
              return;
            }

            let html = `
              <div class="table-wrapper">
                <table>
                  <thead>
                    <tr>
                      <th>Category</th>
                      <th>Name</th>
                      <th>Department</th>
                      <th>Building</th>
                      <th>Location</th>
                      <th>When</th>
                      <th>Link</th>
                      <th>Total Uses</th>
                      <th>Unique Students</th>
                    </tr>
                  </thead>
                  <tbody>
            `;

            data.forEach(item => {
              const when = item.weekday
                ? `${item.weekday} ${item.start_time || ""}-${item.end_time || ""}`.trim()
                : "";
              const link = item.link
                ? `<a href="${escapeHtml(item.link)}" target="_blank">Link</a>`
                : "";

              html += `
                <tr>
                  <td>${escapeHtml(item.category)}</td>
                  <td>${escapeHtml(item.name)}</td>
                  <td>${escapeHtml(item.department)}</td>
                  <td>${escapeHtml(item.building)}</td>
                  <td>${escapeHtml(item.location)}</td>
                  <td>${escapeHtml(when)}</td>
                  <td>${link}</td>
                  <td>${item.total_visits || 0}</td>
                  <td>${item.unique_students || 0}</td>
                </tr>
              `;
            });

            html += `
                  </tbody>
                </table>
              </div>
            `;

            popularContainer.innerHTML = html;
          } catch (err) {
            console.error(err);
            popularContainer.innerHTML =
              "<p>Network error loading popular resources. Please try again.</p>";
          }
        }

        // ------------------------
        // Load resources
        // ------------------------
        // Apply both category + text search to allResources and render
        function applyResourceFilters() {
          const cat   = filterCategory.value;
          const term  = filterSearch.value.toLowerCase().trim();

          let filtered = allResources;

          if (cat) {
            filtered = filtered.filter(r => r.category_key === cat);
          }

          if (term) {
            filtered = filtered.filter(r => {
              // search across multiple fields
              return [
                r.category,
                r.name,
                r.department,
                r.building,
                r.location,
                r.weekday,
                r.start_time,
                r.end_time,
                r.notes
              ].some(field =>
                (field || "").toString().toLowerCase().includes(term)
              );
            });
          }

          renderResourceTable(filtered);
        }

        // Load resources from server using current filters
        async function loadResources() {
          const cat  = filterCategory.value;
          const term = filterSearch.value.trim();

          const params = new URLSearchParams();
          if (cat)  params.set("category", cat);
          if (term) params.set("search", term);

          resourceWrapper.innerHTML = "<p>Loading resources...</p>";

          try {
            const res = await fetch("/api/resources?" + params.toString());
            if (!res.ok) {
              resourceWrapper.innerHTML = "<p>Error loading resources.</p>";
              return;
            }
            const data = await res.json();
            renderResourceTable(data);   // same function you already have
          } catch (err) {
            console.error(err);
            resourceWrapper.innerHTML = "<p>Network error loading resources.</p>";
          }
        }

        // On page load
        loadResources();

        // Whenever filters change, re-query the backend
        filterCategory.addEventListener("change", loadResources);
        filterSearch.addEventListener("input", loadResources);

        // ------------------------
        // Checkout handler
        // ------------------------
        checkoutForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          checkoutStatus.textContent = "";

          const name = document.getElementById("checkout-name").value.trim();
          const id   = document.getElementById("checkout-id").value.trim();
          const pw   = document.getElementById("checkout-password").value.trim();

          if (!name || !id || !pw) {
            checkoutStatus.textContent = "Please fill out name, ID, and password.";
            checkoutStatus.style.color = "red";
            return;
          }
          if (!cart.length) {
            checkoutStatus.textContent = "Your cart is empty.";
            checkoutStatus.style.color = "red";
            return;
          }

          const payload = {
            studentName: name,
            studentID: id,
            password: pw,
            items: cart.map(c => ({
              category_key: c.category_key,
              resource_id: c.resource_id
            }))
          };

          try {
            const res = await fetch("/api/cart/checkout", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
              checkoutStatus.textContent = "Error: " + (data.error || "Checkout failed.");
              checkoutStatus.style.color = "red";
              return;
            }
            checkoutStatus.textContent = `Success! ${data.inserted || 0} item(s) recorded.`;
            checkoutStatus.style.color = "green";
            cart = [];
            renderCart();
          } catch (err) {
            console.error(err);
            checkoutStatus.textContent = "Network error during checkout.";
            checkoutStatus.style.color = "red";
          }
        });

        // ------------------------
        // History: delete handler (delegated)
        // ------------------------
        historyResults.addEventListener("click", async function (e) {
          const btn = e.target.closest("button[data-delete-index]");
          if (!btn) return;

          const index = parseInt(btn.getAttribute("data-delete-index"), 10);
          if (isNaN(index) || !historyData[index]) return;

          if (!historyStudentID || !historyPassword) {
            alert("No student login in context. Please load your history again.");
            return;
          }

          if (!confirm("Delete this entry from your history?")) return;

          const entry = historyData[index];

          const payload = {
            studentID: historyStudentID,
            password: historyPassword,
            entry: {
              category_key: entry.category_key,
              resource_id:  entry.resource_id
            }
          };

          try {
            const res = await fetch("/api/resources-history/delete", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok || !data.success) {
              alert("Error deleting entry: " + (data.error || "Unknown error."));
              return;
            }
            // Remove from local list and re-render
            historyData.splice(index, 1);
            renderHistoryTable(historyData);
          } catch (err) {
            console.error(err);
            alert("Network error while deleting entry.");
          }
        });

        // ------------------------
        // History form submit
        // ------------------------
        historyForm.addEventListener("submit", async function (e) {
          e.preventDefault();
          historyResults.innerHTML = "<p>Loading history...</p>";

          const id = document.getElementById("history-id").value.trim();
          const pw = document.getElementById("history-password").value.trim();

          if (!id || !pw) {
            historyResults.innerHTML = "<p>Please enter your student ID and password.</p>";
            return;
          }

          try {
            const res = await fetch("/api/resources-history", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ studentID: id, password: pw })
            });
            const data = await res.json();
            if (!res.ok) {
              historyResults.innerHTML = `<p>Error: ${data.error || "Unable to load history."}</p>`;
              return;
            }

            historyStudentID = id;
            historyPassword  = pw;
            historyData = Array.isArray(data) ? data : [];
            renderHistoryTable(historyData);
          } catch (err) {
            console.error(err);
            historyResults.innerHTML = "<p>Network error loading history.</p>";
          }
        });

        // Initial load
        renderCart();
        loadResources();
        loadPopularResources();
      });
    </script>

  </body>
</html>
